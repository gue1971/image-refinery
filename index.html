<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Refinery (v4.0 Safe-Mode)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #222;
            color: #eee;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        .controls {
            padding: 10px 15px;
            background: #333;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
            flex-wrap: wrap;
        }
        
        .img-container {
            flex-grow: 1;
            width: 100%;
            height: calc(100vh - 70px);
            background: #000;
            overflow: hidden;
            position: relative;
        }
        .placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            text-align: center;
            pointer-events: none;
        }

        input[type="text"], select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #555;
            background: #222;
            color: #fff;
            font-size: 16px;
            text-align: center;
        }
        input[type="text"]:focus, select:focus {
            border-color: #007bff;
            outline: none;
        }
        
        button {
            padding: 8px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            white-space: nowrap;
        }
        button:hover { background-color: #0056b3; }

        /* モーダル（保存時のポップアップ） */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            width: 300px;
            text-align: center;
        }
        .modal h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #fff;
            font-size: 18px;
        }
        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .size-btn {
            background: #444;
            border: 1px solid #555;
            padding: 10px;
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .size-btn:hover, .size-btn.active {
            background: #007bff;
            border-color: #007bff;
        }
        .modal-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .cancel-btn {
            background: #666;
            flex: 1;
        }
        .confirm-btn {
            background: #28a745;
            flex: 1;
        }
    </style>
</head>
<body>

<div class="controls">
    <input type="file" id="imageInput" accept="image/*" style="max-width: 200px; color: #aaa;">
    
    <select id="ratioSelect" title="トリミング比率">
        <option value="1.33333" selected>比率 4:3</option>
        <option value="1">比率 1:1</option>
        <option value="1.77777">比率 16:9</option>
        <option value="1.5">比率 3:2</option>
        <option value="NaN">フリー</option>
    </select>

    <input type="text" id="filenameInput" placeholder="YYYYMMDD" style="width: 120px;">
    <button id="preSaveBtn">保存へ (Enter)</button>
</div>

<div class="img-container">
    <div class="placeholder">画像をドラッグ＆ドロップ<br>またはファイルを選択</div>
    <img id="image" style="max-width: 100%; display: block;">
</div>

<div id="saveModal" class="modal-overlay">
    <div class="modal">
        <h3>書き出しサイズを選択</h3>
        <div id="sizeOptions" class="modal-options">
            </div>
        
        <div style="margin-bottom: 15px; text-align: left; font-size: 14px; color: #aaa;">
            <label>
                カスタム幅: <input type="number" id="customWidth" placeholder="px" style="width: 60px; padding: 4px;"> px
            </label>
        </div>

        <div class="modal-actions">
            <button class="cancel-btn" id="modalCancel">キャンセル</button>
            <button class="confirm-btn" id="modalConfirm">決定 (Enter)</button>
        </div>
    </div>
</div>

<script>
    const image = document.getElementById('image');
    const input = document.getElementById('imageInput');
    const filenameInput = document.getElementById('filenameInput');
    const preSaveBtn = document.getElementById('preSaveBtn');
    const ratioSelect = document.getElementById('ratioSelect');
    
    // モーダル要素
    const saveModal = document.getElementById('saveModal');
    const sizeOptions = document.getElementById('sizeOptions');
    const customWidthInput = document.getElementById('customWidth');
    const modalCancel = document.getElementById('modalCancel');
    const modalConfirm = document.getElementById('modalConfirm');

    let cropper;
    let selectedWidth = null; // nullなら原寸

    // ---------------------------
    // 基本操作
    // ---------------------------

    input.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) loadFile(e.target.files[0]);
    });

    document.body.addEventListener('dragover', (e) => e.preventDefault());
    document.body.addEventListener('drop', (e) => {
        e.preventDefault();
        if (e.dataTransfer.files.length > 0) {
            loadFile(e.dataTransfer.files[0]);
            input.files = e.dataTransfer.files;
        }
    });

    ratioSelect.addEventListener('change', () => {
        if (!cropper) return;
        const val = parseFloat(ratioSelect.value);
        cropper.setAspectRatio(val); // フリー(NaN)もこれでOK
    });

    function loadFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            image.src = e.target.result;
            
            EXIF.getData(file, function() {
                const date = EXIF.getTag(this, "DateTimeOriginal");
                if (date) {
                    const formattedDate = date.split(' ')[0].replace(/:/g, '');
                    filenameInput.value = formattedDate;
                } else {
                    filenameInput.value = ""; 
                }
            });

            if (cropper) cropper.destroy();
            const initialRatio = parseFloat(ratioSelect.value);

            cropper = new Cropper(image, {
                aspectRatio: initialRatio,
                viewMode: 1, 
                dragMode: 'move',
                autoCropArea: 0.8,
                toggleDragModeOnDblclick: false,
                ready: function() {
                    document.activeElement.blur();
                }
            });
        };
        reader.readAsDataURL(file);
    }

    // ---------------------------
    // キーボード操作 & 保存フロー
    // ---------------------------

    document.addEventListener('keydown', (e) => {
        // モーダルが開いている時
        if (saveModal.style.display === 'flex') {
            if (e.key === 'Escape') closeModal();
            if (e.key === 'Enter') {
                e.preventDefault();
                executeSave();
            }
            return;
        }

        // 入力フォームでのEnter
        if (e.target.tagName === 'INPUT') {
            if (e.isComposing) return;
            if (e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
                openModal(); // ファイル名入力後すぐに保存へ
            }
            return;
        }

        if (!cropper) return;

        // 矢印キー（トリミング調整）
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
            e.preventDefault();
            let data = cropper.getData();
            const shift = e.shiftKey;
            const resizeStep = 4; 
            const moveStep = 1;

            if (shift) {
                // アスペクト比維持リサイズ
                const currentRatio = data.width / data.height;
                let deltaW = 0;
                if (e.key === 'ArrowRight' || e.key === 'ArrowUp') deltaW = resizeStep;
                else deltaW = -resizeStep;

                let deltaH = deltaW / currentRatio;
                
                if (data.width + deltaW > 10 && data.height + deltaH > 10) {
                    data.width += deltaW;
                    data.height += deltaH;
                    data.x -= (deltaW / 2);
                    data.y -= (deltaH / 2);
                    cropper.setData(data);
                }
            } else {
                if (e.key === 'ArrowLeft') data.x -= moveStep;
                if (e.key === 'ArrowRight') data.x += moveStep;
                if (e.key === 'ArrowUp') data.y -= moveStep;
                if (e.key === 'ArrowDown') data.y += moveStep;
                cropper.setData(data);
            }
        }

        if (e.key === 'Enter') {
            e.preventDefault();
            openModal();
        }
    });

    preSaveBtn.addEventListener('click', openModal);
    modalCancel.addEventListener('click', closeModal);
    modalConfirm.addEventListener('click', executeSave);

    // ---------------------------
    // モーダルロジック
    // ---------------------------

    function openModal() {
        if (!cropper) return;
        
        // ファイル名チェック
        let filename = filenameInput.value.trim();
        if (!filename) {
            alert("先にファイル名（日付）を入力して！");
            filenameInput.focus();
            return;
        }

        // 現在の切り抜き実寸を取得
        const data = cropper.getData();
        const currentW = Math.round(data.width);
        const currentH = Math.round(data.height);
        const ratio = currentW / currentH;

        // モーダルの中身をリセット
        sizeOptions.innerHTML = '';
        customWidthInput.value = '';
        selectedWidth = null; // 初期値は原寸（null）

        // 1. 原寸ボタン（デフォルト）
        createOptionBtn(`そのまま (${currentW} x ${currentH})`, null, true);

        // 2. プリセットボタン（比率に応じたサイズを提案）
        // 代表的な幅のリスト
        const targets = [640, 800, 1024, 1280];
        
        targets.forEach(w => {
            // 元画像より大きく引き伸ばすのは荒れるので除外（お好みで）
            // ここでは利便性のため全部出す
            const h = Math.round(w / ratio);
            createOptionBtn(`幅 ${w}px (${w} x ${h})`, w, false);
        });

        saveModal.style.display = 'flex';
        modalConfirm.focus(); // Enter連打で保存できるようにフォーカス
    }

    function createOptionBtn(text, widthVal, isDefault) {
        const btn = document.createElement('div');
        btn.className = 'size-btn';
        btn.textContent = text;
        if (isDefault) btn.classList.add('active');

        btn.addEventListener('click', () => {
            // 他のボタンのactiveを消す
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedWidth = widthVal;
            customWidthInput.value = ''; // カスタム入力はクリア
        });

        sizeOptions.appendChild(btn);
    }

    // カスタム入力欄をいじったら選択状態をクリアしてカスタム優先にする
    customWidthInput.addEventListener('input', () => {
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        selectedWidth = 'custom';
    });

    function closeModal() {
        saveModal.style.display = 'none';
        document.activeElement.blur();
    }

    function executeSave() {
        if (!cropper) return;
        
        let filename = filenameInput.value.trim();
        const options = {
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        };

        // サイズ決定ロジック
        let finalWidth = null;

        if (selectedWidth === 'custom') {
            const val = parseInt(customWidthInput.value);
            if (val > 0) finalWidth = val;
        } else if (selectedWidth !== null) {
            finalWidth = selectedWidth;
        }

        if (finalWidth) {
            options.width = finalWidth;
            // 高さはCropperが比率維持で自動計算
        }

        const canvas = cropper.getCroppedCanvas(options);

        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '.jpeg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            closeModal(); // 保存後に閉じる
        }, 'image/jpeg', 0.9);
    }

</script>

</body>
</html>