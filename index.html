<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Image Refinery (v24.0 Slim & Spaced)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #222;
            color: #eee;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* --- メインエリア --- */
        .img-container {
            flex-grow: 1;
            width: 100%;
            /* ヘッダー高さ分を引く (60px) */
            height: calc(100vh - 60px);
            background: #000;
            overflow: hidden;
            position: relative;
        }
        .placeholder {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            text-align: center;
            pointer-events: none;
            z-index: 0;
        }

        /* --- 情報オーバーレイ --- */
        .info-overlay {
            position: absolute;
            top: 15px; left: 15px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            padding: 6px 12px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.8);
            font-size: 0.7rem;
            pointer-events: none;
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .info-row { display: flex; gap: 6px; align-items: center; }
        .info-val {
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-weight: bold;
            color: #fff;
        }

        /* --- コントロールパネル (スリム化) --- */
        .controls-panel-custom {
            width: 100%;
            padding: 5px 15px; /* 余白削減 */
            box-sizing: border-box;
            background: #333;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            z-index: 20;
            /* ★高さ変更: 80px -> 60px */
            height: 60px;
        }

        /* ガラス風共通 */
        .glass-btn {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            color: #fff;
            border-radius: 8px; /* 丸みを少し抑える */
            cursor: pointer; 
            transition: all 0.2s;
            
            /* ★ボタンサイズ変更: 50px -> 40px */
            height: 40px;
            min-width: 40px;
            
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            padding: 0 10px;
        }
        .glass-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-1px); }
        .glass-btn.active { background: rgba(0, 123, 255, 0.6); border-color: #007bff; color: #fff; }

        /* SVGアイコン (小さく) */
        .icon-svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* ファイル選択 */
        .file-upload-wrapper input[type="file"] { display: none; }
        .custom-file-upload { padding: 0; width: 40px; }

        /* 比率ボタン */
        .ratio-display-btn {
            min-width: 90px;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        .ratio-icon { font-size: 0.7rem; color: #aaa; margin-left: 6px; }

        /* 保存ボタン */
        .save-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            width: 40px; 
            padding: 0;
        }
        .save-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }


        /* --- 微調整コントローラー (隙間あり配置) --- */
        #fineTuneController {
            display: none;
            position: absolute;
            bottom: 100px; /* ヘッダーが低くなった分、少し下げる */
            left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 450px;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 15;
        }
        
        .tune-pad {
            pointer-events: auto;
            background: transparent;
            border: none;
        }

        .tune-btn {
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            width: 72px; height: 72px; 
            font-size: 2rem; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            user-select: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            transition: transform 0.1s, background 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .tune-btn:active { 
            background: rgba(0, 123, 255, 0.6); 
            color: #fff;
            transform: scale(0.95);
        }

        /* 左: サイズ */
        .size-pad { 
            display: flex; 
            flex-direction: column; 
            gap: 16px; /* 縦の間隔 */
        }
        
        /* 右: 移動 (グリッドで隙間を作る) */
        .move-pad {
            display: grid;
            grid-template-areas: 
                ". up ."
                "left . right"
                ". down .";
            /* ★修正: 隙間をしっかり空ける */
            gap: 8px; 
        }
        .btn-up { grid-area: up; }
        .btn-down { grid-area: down; }
        .btn-left { grid-area: left; }
        .btn-right { grid-area: right; }


        /* --- モーダル --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85);
            z-index: 2000; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal {
            background: #2a2a2a; padding: 25px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); width: 380px; max-width: 90%;
            border: 1px solid #444; max-height: 90vh; overflow-y: auto;
        }
        .modal h3 {
            margin-top: 0; margin-bottom: 20px; color: #fff; font-size: 18px;
            border-bottom: 1px solid #444; padding-bottom: 15px;
        }

        /* 比率リスト */
        .ratio-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; }
        .ratio-group { display: flex; flex-direction: column; gap: 8px; }
        .ratio-group-header {
            font-size: 0.85rem; color: #aaa; font-weight: bold;
            border-left: 3px solid #007bff; padding-left: 8px; margin-bottom: 4px;
        }
        .ratio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .ratio-item {
            background: #3a3a3a; border: 1px solid #444; padding: 10px 12px;
            border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; transition: background 0.2s;
            gap: 12px; height: 44px;
        }
        .ratio-item:hover { background: #4a4a4a; border-color: #666; }
        .ratio-info { display: flex; flex-direction: column; justify-content: center; line-height: 1.2; }
        .ratio-item-main { font-weight: bold; font-size: 1.05rem; color: #fff; }
        .ratio-item-sub { font-size: 0.8rem; color: #ccc; }
        .ratio-shape { display: block; border: 2px solid #ccc; background: rgba(255,255,255,0.1); flex-shrink: 0; }

        /* カスタム入力 */
        .custom-ratio-area { border-top: 1px solid #444; padding-top: 20px; margin-top: 10px; }
        .custom-inputs-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .ratio-input-box {
            width: 75px; background: #222; border: 1px solid #555;
            color: #fff; padding: 12px; border-radius: 4px; text-align: center;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
        }
        .ratio-input-box[readonly] { background-color: #2a2a2a; caret-color: transparent; }
        .ratio-input-box:focus { border-color: #007bff; outline: none; background: #000; }

        /* テンキー */
        .numpad-container {
            display: none; grid-template-columns: repeat(3, 1fr); gap: 8px;
            background: #222; padding: 10px; border-radius: 8px;
            margin-bottom: 15px; margin-top: 10px; animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .numpad-btn {
            background: #3a3a3a; border: 1px solid #444; color: #fff;
            padding: 12px; border-radius: 6px; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; user-select: none; touch-action: manipulation;
        }
        .numpad-btn:hover { background: #555; }
        .numpad-btn:active { background: #007bff; border-color: #007bff; }
        
        .size-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .size-btn {
            background: #3a3a3a; border: 1px solid #444; padding: 12px;
            color: #ccc; cursor: pointer; border-radius: 6px; text-align: center;
            font-weight: bold; font-size: 0.95rem;
        }
        .size-btn:hover, .size-btn.active { background: #007bff; color: #fff; border-color: #007bff; }
        
        .modal-actions { display: flex; gap: 10px; margin-top: 10px;}
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .cancel-btn { background: #555; color: #ddd; }
        .confirm-btn { background: #28a745; color: white; }
        
        .filename-input {
            width: 100%; box-sizing: border-box; margin-bottom: 20px;
            text-align: center; font-size: 18px; padding: 10px;
            background: #222; border: 1px solid #555; color: #fff; border-radius: 4px;
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
    </style>
</head>
<body>

<div class="controls-panel-custom">
    <div class="file-upload-wrapper">
        <label for="imageUpload" class="custom-file-upload glass-btn" title="画像を開く">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>
        </label>
        <input type="file" id="imageUpload" accept="image/*">
    </div>

    <div id="openRatioModalBtn" class="ratio-display-btn glass-btn">
        <span id="currentRatioValue" class="ratio-value">4:3</span>
        <span class="ratio-icon">▼</span>
    </div>

    <div id="toggleFineTuneBtn" class="custom-file-upload glass-btn" style="width: 40px;" title="位置調整">
        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z"/></svg>
    </div>

    <button id="nextBtn" class="save-btn glass-btn" title="保存へ進む">
        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
    </button>
</div>

<div class="img-container">
    <div class="placeholder">画像をドラッグ＆ドロップ<br>またはファイルを選択</div>
    
    <div class="info-overlay">
        <div class="info-row">
            <span>Original:</span><span id="originalSizeText" class="info-val">-</span>
        </div>
        <div class="info-row" style="border-left: 1px solid rgba(255,255,255,0.3); padding-left: 12px;">
            <span>Crop:</span><span id="cropSizeText" class="info-val">-</span>
        </div>
    </div>

    <img id="image" style="max-width: 100%; display: block; opacity: 0;">
    
    <div id="fineTuneController">
        <div class="tune-pad size-pad">
            <div class="tune-btn" id="btnZoomIn" title="拡大">＋</div>
            <div class="tune-btn" id="btnZoomOut" title="縮小">－</div>
        </div>
        <div class="tune-pad move-pad">
            <div class="tune-btn btn-up" id="btnMoveUp">▲</div>
            <div class="tune-btn btn-left" id="btnMoveLeft">◀</div>
            <div class="tune-btn btn-right" id="btnMoveRight">▶</div>
            <div class="tune-btn btn-down" id="btnMoveDown">▼</div>
        </div>
    </div>
</div>

<div id="ratioModal" class="modal-overlay">
    <div class="modal">
        <h3>トリミング比率を選択</h3>
        <div class="ratio-container">
            <div class="ratio-group">
                <div class="ratio-group-header">ランドスケープ</div>
                <div class="ratio-grid">
                    <div class="ratio-item" data-ratio="1.33333" data-text="4:3">
                        <span class="ratio-shape" style="width:18px; height:13.5px;"></span>
                        <div class="ratio-info"><span class="ratio-item-main">4 : 3</span><span class="ratio-item-sub">写真 (Photo)</span></div>
                    </div>
                    <div class="ratio-item" data-ratio="1.5" data-text="3:2">
                        <span class="ratio-shape" style="width:18px; height:12px;"></span>
                        <div class="ratio-info"><span class="ratio-item-main">3 : 2</span><span class="ratio-item-sub">一眼 (Standard)</span></div>
                    </div>
                    <div class="ratio-item" data-ratio="1.77777" data-text="16:9">
                        <span class="ratio-shape" style="width:20px; height:11px;"></span>
                        <div class="ratio-info"><span class="ratio-item-main">16 : 9</span><span class="ratio-item-sub">動画 (Wide)</span></div>
                    </div>
                    <div class="ratio-item" data-ratio="2.35" data-text="2.35:1">
                        <span class="ratio-shape" style="width:21px; height:9px;"></span>
                        <div class="ratio-info"><span class="ratio-item-main">2.35 : 1</span><span class="ratio-item-sub">シネマ (Cinema)</span></div>
                    </div>
                </div>
            </div>
            <div class="ratio-group">
                <div class="ratio-group-header">スクエア・フリー</div>
                <div class="ratio-grid">
                    <div class="ratio-item" data-ratio="1" data-text="1:1">
                        <span class="ratio-shape" style="width:16px; height:16px;"></span>
                        <div class="ratio-info"><span class="ratio-item-main">1 : 1</span><span class="ratio-item-sub">正方形 (Icon)</span></div>
                    </div>
                    <div class="ratio-item" data-ratio="NaN" data-text="Free">
                        <span class="ratio-shape" style="width:16px; height:16px; border-style:dashed;"></span>
                        <div class="ratio-info"><span class="ratio-item-main">Free</span><span class="ratio-item-sub">自由変形</span></div>
                    </div>
                </div>
            </div>
            <div class="ratio-group">
                <div class="ratio-group-header">ポートレート</div>
                <div class="ratio-grid">
                    <div class="ratio-item" data-ratio="0.8" data-text="4:5">
                        <span class="ratio-shape" style="width:13px; height:16px;"></span>
                        <div class="ratio-info"><span class="ratio-item-main">4 : 5</span><span class="ratio-item-sub">SNS (Feed)</span></div>
                    </div>
                    <div class="ratio-item" data-ratio="0.75" data-text="3:4">
                        <span class="ratio-shape" style="width:13.5px; height:18px;"></span>
                        <div class="ratio-info"><span class="ratio-item-main">3 : 4</span><span class="ratio-item-sub">写真 (Photo)</span></div>
                    </div>
                    <div class="ratio-item" data-ratio="0.66666" data-text="2:3">
                        <span class="ratio-shape" style="width:12px; height:18px;"></span>
                        <div class="ratio-info"><span class="ratio-item-main">2 : 3</span><span class="ratio-item-sub">スマホ (Pin)</span></div>
                    </div>
                    <div class="ratio-item" data-ratio="0.5625" data-text="9:16">
                        <span class="ratio-shape" style="width:11px; height:20px;"></span>
                        <div class="ratio-info"><span class="ratio-item-main">9 : 16</span><span class="ratio-item-sub">全画面 (Story)</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="custom-ratio-area">
            <div style="font-size:0.85rem; color:#ccc; margin-bottom:8px; text-align:center; font-weight:bold;">カスタム比率入力 (W : H)</div>
            <div class="custom-inputs-row">
                <input type="number" id="ratioInputW" class="ratio-input-box numpad-target" placeholder="W" min="1" readonly>
                <span>:</span>
                <input type="number" id="ratioInputH" class="ratio-input-box numpad-target" placeholder="H" min="1" readonly>
            </div>
            <div class="numpad-container" id="ratioNumpad">
                <div class="numpad-btn" data-key="7">7</div><div class="numpad-btn" data-key="8">8</div><div class="numpad-btn" data-key="9">9</div>
                <div class="numpad-btn" data-key="4">4</div><div class="numpad-btn" data-key="5">5</div><div class="numpad-btn" data-key="6">6</div>
                <div class="numpad-btn" data-key="1">1</div><div class="numpad-btn" data-key="2">2</div><div class="numpad-btn" data-key="3">3</div>
                <div class="numpad-btn" data-key="0">0</div><div class="numpad-btn" data-key="BS">⌫</div><div class="numpad-btn" data-key="C">C</div>
            </div>
            <div class="modal-actions">
                <button id="closeRatioModal" class="action-btn cancel-btn">閉じる</button>
                <button id="applyCustomRatio" class="action-btn confirm-btn">適用</button>
            </div>
        </div>
    </div>
</div>

<div id="sizeModal" class="modal-overlay">
    <div class="modal">
        <h3>1. 書き出しサイズ指定</h3>
        <div id="sizeOptions" class="size-grid"></div>
        <div class="custom-ratio-area" style="border-top:none; padding-top:0;">
            <div style="font-size:0.85rem; color:#ccc; margin-bottom:8px; text-align:center; font-weight:bold;">カスタムサイズ (px)</div>
            <div class="custom-inputs-row">
                <input type="number" id="customW" class="ratio-input-box numpad-target" style="width:80px;" placeholder="W" readonly>
                <span>x</span>
                <input type="number" id="customH" class="ratio-input-box numpad-target" style="width:80px;" placeholder="H" readonly>
            </div>
            <div class="numpad-container" id="sizeNumpad">
                <div class="numpad-btn" data-key="7">7</div><div class="numpad-btn" data-key="8">8</div><div class="numpad-btn" data-key="9">9</div>
                <div class="numpad-btn" data-key="4">4</div><div class="numpad-btn" data-key="5">5</div><div class="numpad-btn" data-key="6">6</div>
                <div class="numpad-btn" data-key="1">1</div><div class="numpad-btn" data-key="2">2</div><div class="numpad-btn" data-key="3">3</div>
                <div class="numpad-btn" data-key="0">0</div><div class="numpad-btn" data-key="BS">⌫</div><div class="numpad-btn" data-key="C">C</div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="action-btn cancel-btn" id="sizeCancel">戻る</button>
            <button class="action-btn confirm-btn" id="sizeConfirm">決定</button>
        </div>
    </div>
</div>

<div id="nameModal" class="modal-overlay">
    <div class="modal">
        <h3>2. ファイル名を入力</h3>
        <input type="text" id="filenameInput" class="filename-input" placeholder="ファイル名">
        <div style="color:#888; font-size:12px; margin-bottom:15px;">.jpeg で保存されます</div>
        <div class="modal-actions">
            <button class="action-btn cancel-btn" id="nameCancel">戻る</button>
            <button class="action-btn confirm-btn" id="nameConfirm">保存実行</button>
        </div>
    </div>
</div>

<script>
    const image = document.getElementById('image');
    const input = document.getElementById('imageUpload');
    const nextBtn = document.getElementById('nextBtn');
    
    const openRatioModalBtn = document.getElementById('openRatioModalBtn');
    const ratioModal = document.getElementById('ratioModal');
    const closeRatioModal = document.getElementById('closeRatioModal');
    const currentRatioValue = document.getElementById('currentRatioValue');
    const originalSizeText = document.getElementById('originalSizeText');
    const cropSizeText = document.getElementById('cropSizeText');

    const toggleFineTuneBtn = document.getElementById('toggleFineTuneBtn');
    const fineTuneController = document.getElementById('fineTuneController');

    const ratioItems = document.querySelectorAll('.ratio-item');
    const ratioInputW = document.getElementById('ratioInputW');
    const ratioInputH = document.getElementById('ratioInputH');
    const applyCustomRatio = document.getElementById('applyCustomRatio');
    const ratioNumpad = document.getElementById('ratioNumpad');
    
    const sizeModal = document.getElementById('sizeModal');
    const sizeOptions = document.getElementById('sizeOptions');
    const customW = document.getElementById('customW');
    const customH = document.getElementById('customH');
    const sizeCancel = document.getElementById('sizeCancel');
    const sizeConfirm = document.getElementById('sizeConfirm');
    const sizeNumpad = document.getElementById('sizeNumpad');

    const nameModal = document.getElementById('nameModal');
    const filenameInput = document.getElementById('filenameInput');
    const nameCancel = document.getElementById('nameCancel');
    const nameConfirm = document.getElementById('nameConfirm');

    let cropper;
    let currentPhase = 'main'; 
    let selectedSize = null; 
    let originalBaseName = "";
    let exifDateName = "";
    let currentAspectRatio = 1.33333; 

    // --- 微調整機能 ---
    toggleFineTuneBtn.addEventListener('click', () => {
        if (!cropper) return;
        const isVisible = fineTuneController.style.display === 'flex';
        fineTuneController.style.display = isVisible ? 'none' : 'flex';
        toggleFineTuneBtn.classList.toggle('active');
    });

    const fineTuneAction = (action) => {
        if (!cropper) return;
        const data = cropper.getData();
        const currentRatio = isNaN(currentAspectRatio) ? (data.width / data.height) : currentAspectRatio;
        
        if (action === 'up') data.y -= 1;
        if (action === 'down') data.y += 1;
        if (action === 'left') data.x -= 1;
        if (action === 'right') data.x += 1;
        
        if (action === 'zoomIn' || action === 'zoomOut') {
            const delta = (action === 'zoomIn') ? 1 : -1;
            const newWidth = data.width + delta;
            if (newWidth < 10) return;

            let newHeight;
            if (isNaN(currentAspectRatio)) {
                newHeight = newWidth / (data.width / data.height);
            } else {
                newHeight = newWidth / currentRatio;
            }

            const centerX = data.x + (data.width / 2);
            const centerY = data.y + (data.height / 2);
            data.width = newWidth;
            data.height = newHeight;
            data.x = centerX - (newWidth / 2);
            data.y = centerY - (newHeight / 2);
        }

        cropper.setData(data);
        updateCropSizeDisplay(data);
    };

    document.getElementById('btnMoveUp').onclick = () => fineTuneAction('up');
    document.getElementById('btnMoveDown').onclick = () => fineTuneAction('down');
    document.getElementById('btnMoveLeft').onclick = () => fineTuneAction('left');
    document.getElementById('btnMoveRight').onclick = () => fineTuneAction('right');
    document.getElementById('btnZoomIn').onclick = () => fineTuneAction('zoomIn');
    document.getElementById('btnZoomOut').onclick = () => fineTuneAction('zoomOut');


    // --- テンキー制御 ---
    let lastFocusedInput = null; 
    const numpadTargets = document.querySelectorAll('.numpad-target');
    numpadTargets.forEach(input => {
        input.addEventListener('focus', function() {
            lastFocusedInput = this;
            this.dataset.selected = "true";
            this.style.borderColor = "#007bff";
            numpadTargets.forEach(el => {
                if(el !== this) {
                    el.style.borderColor = "#555";
                    el.dataset.selected = "false";
                }
            });
            if (ratioModal.style.display === 'flex') {
                ratioNumpad.style.display = 'grid';
            } else if (sizeModal.style.display === 'flex') {
                sizeNumpad.style.display = 'grid';
            }
        });
        input.addEventListener('click', function() { this.focus(); });
    });

    document.querySelectorAll('.numpad-btn').forEach(btn => {
        btn.addEventListener('mousedown', (e) => e.preventDefault()); 
        btn.addEventListener('click', () => {
            const key = btn.dataset.key;
            if (!lastFocusedInput || !lastFocusedInput.offsetParent) return;
            let currentVal = lastFocusedInput.value.toString();
            const isSelectedAll = lastFocusedInput.dataset.selected === "true";

            if (key === 'C') {
                lastFocusedInput.value = '';
            } else if (key === 'BS') {
                if (isSelectedAll) lastFocusedInput.value = ''; 
                else lastFocusedInput.value = currentVal.slice(0, -1);
            } else {
                if (isSelectedAll) lastFocusedInput.value = key; 
                else lastFocusedInput.value = currentVal + key; 
            }
            lastFocusedInput.dataset.selected = "false";
            lastFocusedInput.dispatchEvent(new Event('input'));
        });
    });

    // --- 画像ロード ---
    input.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) loadFile(e.target.files[0]);
    });
    document.body.addEventListener('dragover', (e) => e.preventDefault());
    document.body.addEventListener('drop', (e) => {
        e.preventDefault();
        if (e.dataTransfer.files.length > 0) {
            loadFile(e.dataTransfer.files[0]);
            input.files = e.dataTransfer.files; 
        }
    });

    function loadFile(file) {
        const nameParts = file.name.split('.');
        if (nameParts.length > 1) nameParts.pop();
        originalBaseName = nameParts.join('.');

        const reader = new FileReader();
        reader.onload = (e) => {
            image.src = e.target.result;
            image.style.opacity = 1;

            EXIF.getData(file, function() {
                const date = EXIF.getTag(this, "DateTimeOriginal");
                if (date) exifDateName = date.split(' ')[0].replace(/:/g, '');
            });

            image.onload = () => {
                originalSizeText.innerText = `${image.naturalWidth} x ${image.naturalHeight}`;

                if (cropper) cropper.destroy();

                cropper = new Cropper(image, {
                    aspectRatio: currentAspectRatio, 
                    viewMode: 1, 
                    dragMode: 'move', 
                    autoCropArea: 0.9,
                    toggleDragModeOnDblclick: false,
                    ready: function() {
                        document.activeElement.blur();
                        updateCropSizeDisplay();
                    },
                    crop: function(event) {
                        updateCropSizeDisplay(event.detail);
                    }
                });
            };
        };
        reader.readAsDataURL(file);
    }
    
    function updateCropSizeDisplay(detail) {
        if (!detail && cropper) detail = cropper.getData();
        if (detail) {
            const w = Math.round(detail.width);
            const h = Math.round(detail.height);
            cropSizeText.innerText = `${w} x ${h}`;
        } else {
            cropSizeText.innerText = "-";
        }
    }

    // --- 比率モーダル ---
    openRatioModalBtn.addEventListener('click', () => {
        ratioModal.style.display = 'flex';
        ratioNumpad.style.display = 'none'; 
        numpadTargets.forEach(el => el.style.borderColor = "#555");
    });
    closeRatioModal.addEventListener('click', () => {
        ratioModal.style.display = 'none';
    });
    ratioItems.forEach(item => {
        item.addEventListener('click', () => {
            if(!item.dataset.ratio) return; 
            applyRatio(parseFloat(item.dataset.ratio), item.dataset.text);
        });
    });
    applyCustomRatio.addEventListener('click', () => {
        const w = parseFloat(ratioInputW.value);
        const h = parseFloat(ratioInputH.value);
        if (w > 0 && h > 0) applyRatio(w / h, `${w}:${h}`);
        else alert("数値を入力してください");
    });

    function applyRatio(newRatio, text) {
        currentRatioValue.innerText = text;
        currentAspectRatio = newRatio;
        if (cropper) {
            if (isNaN(newRatio)) {
                cropper.setAspectRatio(NaN);
            } else {
                const currentData = cropper.getData();
                const centerX = currentData.x + (currentData.width / 2);
                const centerY = currentData.y + (currentData.height / 2);
                cropper.setAspectRatio(newRatio);
                const newWidth = currentData.width;
                const newHeight = newWidth / newRatio;
                cropper.setData({
                    x: centerX - (newWidth / 2),
                    y: centerY - (newHeight / 2),
                    width: newWidth, height: newHeight
                });
            }
        }
        ratioModal.style.display = 'none';
    }


    // --- サイズモーダル ---
    nextBtn.addEventListener('click', openSizeModal);

    function openSizeModal() {
        if (!cropper) { alert("画像を読み込んでください"); return; }
        
        currentPhase = 'size';
        sizeModal.style.display = 'flex';
        sizeNumpad.style.display = 'none';
        numpadTargets.forEach(el => el.style.borderColor = "#555");
        
        const data = cropper.getData();
        const currentW = Math.round(data.width);
        const currentH = Math.round(data.height);
        
        const effectiveRatio = isNaN(currentAspectRatio) ? (data.width / data.height) : currentAspectRatio;

        sizeOptions.innerHTML = '';
        
        const defaultLongSide = 640;
        let defaultW, defaultH;
        
        if (effectiveRatio < 1) {
            defaultH = defaultLongSide;
            defaultW = Math.round(defaultLongSide * effectiveRatio);
        } else {
            defaultW = defaultLongSide;
            defaultH = Math.round(defaultLongSide / effectiveRatio);
        }
        
        selectedSize = { width: defaultW, height: defaultH };
        customW.value = defaultW;
        customH.value = defaultH;
        lastFocusedInput = customW;
        customW.dataset.selected = "true";
        customW.style.borderColor = "#007bff";

        createSizeBtn(`${currentW} x ${currentH}`, {width: currentW, height: currentH}, false);

        const presets = [512, 640, 800, 1024, 1080, 1280, 1350, 1920];
        presets.forEach(size => {
            let w, h;
            if (effectiveRatio < 1) {
                h = size;
                w = Math.round(size * effectiveRatio);
            } else {
                w = size;
                h = Math.round(size / effectiveRatio);
            }
            const isActive = (size === defaultLongSide);
            createSizeBtn(`${w} x ${h}`, {width: w, height: h}, isActive);
        });

        const updateCustom = (e) => {
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            const input = e.target;
            
            if (input === customW) {
                const w = parseFloat(customW.value);
                if (w > 0) customH.value = Math.round(w / effectiveRatio);
            } else {
                const h = parseFloat(customH.value);
                if (h > 0) customW.value = Math.round(h * effectiveRatio);
            }
            if (customW.value && customH.value) {
                selectedSize = { width: parseInt(customW.value), height: parseInt(customH.value) };
            }
        };
        customW.oninput = updateCustom;
        customH.oninput = updateCustom;
    }

    function createSizeBtn(text, sizeVal, isActive) {
        const btn = document.createElement('div');
        btn.className = 'size-btn';
        if (isActive) btn.classList.add('active');
        btn.innerText = text;
        btn.addEventListener('click', () => {
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedSize = sizeVal;
            if (sizeVal) {
                customW.value = sizeVal.width;
                customH.value = sizeVal.height;
                lastFocusedInput = customW;
                customW.dataset.selected = "true";
                customW.style.borderColor = "#007bff";
                customH.style.borderColor = "#555";
            }
        });
        sizeOptions.appendChild(btn);
    }

    sizeCancel.addEventListener('click', () => {
        sizeModal.style.display = 'none';
        currentPhase = 'main';
    });
    sizeConfirm.addEventListener('click', openNameModal);

    // --- 名前モーダル ---
    function openNameModal() {
        sizeModal.style.display = 'none';
        nameModal.style.display = 'flex';
        currentPhase = 'name';
        const defaultName = exifDateName || originalBaseName || "image";
        filenameInput.value = defaultName;
        filenameInput.focus();
        setTimeout(() => filenameInput.select(), 50); 
    }
    nameCancel.addEventListener('click', () => {
        nameModal.style.display = 'none';
        sizeModal.style.display = 'flex';
        currentPhase = 'size';
    });
    nameConfirm.addEventListener('click', executeSave);

    // --- キーボード ---
    document.addEventListener('keydown', (e) => {
        if (e.isComposing) return;
        if (e.key === 'Enter') {
            if (currentPhase === 'name') executeSave();
            else if (currentPhase === 'size') sizeConfirm.click();
            return;
        }
        if (e.key === 'Escape') {
            if (currentPhase === 'name') nameCancel.click();
            else if (currentPhase === 'size') sizeCancel.click();
            else if (ratioModal.style.display === 'flex') closeRatioModal.click();
            return;
        }
        if (currentPhase === 'main' && cropper && ratioModal.style.display !== 'flex') {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
                fineTuneAction(e.key.replace('Arrow', '').toLowerCase());
            }
        }
    });

    function executeSave() {
        if (!cropper) return;
        let filename = filenameInput.value.trim() || "image";
        const options = { imageSmoothingEnabled: true, imageSmoothingQuality: 'high' };
        if (selectedSize) {
            options.width = selectedSize.width;
            options.height = selectedSize.height;
        }
        const canvas = cropper.getCroppedCanvas(options);
        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '.jpeg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            nameModal.style.display = 'none';
            currentPhase = 'main';
        }, 'image/jpeg', 0.9);
    }
</script>

</body>
</html>